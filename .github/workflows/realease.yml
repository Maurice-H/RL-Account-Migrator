name: Build EXE, Beta Drafts & Releases

on:
  push:
    branches:
      - main
    tags:
      - "v*.*.*"

env:
  PYTHON_VERSION: "3.12"
  EXE_BASENAME: RLAccountMigrator
  ICON_PATH: assets/icons/app.ico

jobs:
  build-and-package:
    name: Build & Package (Windows)
    runs-on: windows-latest
    outputs:
      version: ${{ steps.meta.outputs.version }}
      short_sha: ${{ steps.meta.outputs.short_sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: pip install poetry

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Read version and generate metadata
        id: meta
        shell: pwsh
        run: |
          $version = poetry version --short
          $short_sha = git rev-parse --short HEAD
          $major, $minor, $patch = $version -split '\.'

          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "short_sha=$short_sha" >> $env:GITHUB_OUTPUT

          # Create version.txt for PyInstaller
          @"
          VSVersionInfo(
            ffi=FixedFileInfo(
              filevers=($major,$minor,$patch,0),
              prodvers=($major,$minor,$patch,0),
              mask=0x3f,
              flags=0x0,
              OS=0x4,
              fileType=0x1,
              subtype=0x0,
              date=(0, 0)
            ),
            kids=[
              StringFileInfo([
                StringTable(
                  '040904B0',
                  [
                    StringStruct('CompanyName', 'MyCompany'),
                    StringStruct('FileDescription', 'RLAccountMigrator'),
                    StringStruct('FileVersion', '$version'),
                    StringStruct('InternalName', 'RLAccountMigrator'),
                    StringStruct('OriginalFilename', 'RLAccountMigrator.exe'),
                    StringStruct('ProductName', 'RLAccountMigrator'),
                    StringStruct('ProductVersion', '$version')
                  ]
                )
              ]),
              VarFileInfo([VarStruct('Translation', [1033, 1200])])
            ]
          )
          "@ | Out-File -FilePath version.txt -Encoding utf8

      - name: Build EXE with PyInstaller
        run: |
          poetry run pyinstaller RLAccountMigrator.spec

      - name: Upload EXE artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.EXE_BASENAME }}-exe
          path: dist/${{ env.EXE_BASENAME }}.exe

  beta-draft:
    name: "Beta: Draft Release from main"
    needs: build-and-package
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.build-and-package.outputs.version }}
      SHORT_SHA: ${{ needs.build-and-package.outputs.short_sha }}
    steps:
      - name: Download EXE artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.EXE_BASENAME }}-exe
          path: ./work

      - name: Rename EXE for beta release
        run: |
          BETA_VERSION="${VERSION}-beta-${SHORT_SHA}"
          mv work/${{ env.EXE_BASENAME }}.exe work/${{ env.EXE_BASENAME }}-${BETA_VERSION}.exe
          echo "BETA_VERSION=${BETA_VERSION}" >> $GITHUB_ENV

      - name: Create or update Draft Release (beta)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: beta-${{ env.SHORT_SHA }}
          name: Beta ${{ env.BETA_VERSION }}
          draft: true
          files: work/${{ env.EXE_BASENAME }}-${{ env.BETA_VERSION }}.exe
          body: |
            ðŸ§ª **Beta Build** from commit ${{ env.SHORT_SHA }}

            Version: `${{ env.VERSION }}`

            This is an automated pre-release build for testing purposes.
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}

  release:
    name: Official Release for Tag
    needs: build-and-package
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    env:
      TAG: ${{ github.ref_name }}
      VERSION: ${{ needs.build-and-package.outputs.version }}
    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download EXE artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.EXE_BASENAME }}-exe
          path: ./work

      - name: Rename and checksum EXE
        run: |
          mv work/${{ env.EXE_BASENAME }}.exe work/${{ env.EXE_BASENAME }}-${{ env.VERSION }}.exe
          sha256sum work/${{ env.EXE_BASENAME }}-${{ env.VERSION }}.exe > work/${{ env.EXE_BASENAME }}-${{ env.VERSION }}.sha256

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Install git-cliff
        run: cargo install --locked git-cliff

      - name: Generate CHANGELOG
        run: |
          git-cliff --tag ${{ env.TAG }} -o work/CHANGELOG.md || git-cliff -l -o work/CHANGELOG.md

      - name: Read changelog for release body
        id: changelog
        run: |
          {
            echo "body<<EOF"
            head -c 8000 work/CHANGELOG.md
            echo ""
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Publish official release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: ${{ env.TAG }}
          body: ${{ steps.changelog.outputs.body }}
          files: |
            work/${{ env.EXE_BASENAME }}-${{ env.VERSION }}.exe
            work/${{ env.EXE_BASENAME }}-${{ env.VERSION }}.sha256
            work/CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
